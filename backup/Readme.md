
<h1>Резервное копирование</h1>
<p>Настроить удаленный бекап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:</p>
<ul>
  <li>директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB;
  репозиторий дле резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение;</li>
  <li>имя бекапа должно содержать информацию о времени снятия бекапа;</li>
  глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех.
  Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов;
  резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации;</li>
  <li>написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение;</li>
  <li>настроено логирование процесса бекапа. Для упрощения можно весь вывод перенаправлять в logger с соответствующим тегом. Если настроите не в syslog, то обязательна ротация логов.</li>
</ul>

<p>
Vagrant mirror: https://vagrant.elab.pro<br>
Vagrant box: ubuntu/22.04<br>
Ansible playbook: borg.yml  
</p>

<p>Переменная окружения для автоматизации ввода проля: </p>
<code># export BORG_PASSPHRASE="borg"</code>

<p>Инициализация репозитория:</p>
<code># borg init --encryption=repokey --make-parent-dirs borg@192.168.11.160:/var/backup/client/</code>
<pre>
The authenticity of host '192.168.11.160 (192.168.11.160)' can't be established.
ED25519 key fingerprint is SHA256:a/pN2NbwDYTNIE4rkTCBNo4mU+1aKtPvYDxIoHQfI0M.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</pre>
<p>Для автоматизации этого запроса следует сначала импортировать публичный ключ с сервера backup (расположен в файле /etc/ssh/ssh_host_rsa_key.pub) и поместить его в known_hosts пользователя root</p>

<p>Просмотр архивов в репозитории:</p>
<code># borg list borg@192.168.11.160:/var/backup/</code>
<pre>etc-2025-02-23_00:10:50              Sun, 2025-02-23 00:11:04 [6ea99eb526c7c657b2ee9b64a818c1984679eac3a7e25045bacca1670d6ece65]</pre>

<p>Восстановление из архива</p>
<code># borg extract borg@192.168.11.160:/var/backup/::etc-2025-02-23_00:10:50 /etc/issue.net</code>

